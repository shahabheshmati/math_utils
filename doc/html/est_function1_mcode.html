<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1"> 1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T2U3">x</span>,<span class="var type1" id="S3T1U4">Pxx</span> ] = est_function( <span class="mxinfo" id="T2:U3"><span class="mxinfo" id="T2:U4"><span class="var type1" id="S2T2U7">x</span></span></span>,<span class="mxinfo" id="T1:U6"><span class="mxinfo" id="T1:U7"><span class="var type1" id="S3T1U8">Pxx</span></span></span>,<span class="var type1" id="S4T4U9">R</span>,<span class="var type1" id="S5T2U10">AHRS</span>,<span class="var type1" id="S6T23U11">GPS</span>,<span class="var type1" id="S7T3U12">BAR</span>,<span class="var type1" id="S8T3U13">RF</span>,<span class="var type1" id="S9T29U14">type</span>,<span class="var type1" id="S10T3U15">dt</span>,<span class="var type1" id="S11T20U16">Wm</span>,<span class="var type1" id="S12T20U17">Wc</span>,<span class="var type1" id="S13T3U18">c</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3"> 3</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5"> 5</a></span><span class="line"><span class="comment">%UKF state estimation function for small UAVs for landing procedure</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6"> 6</a></span><span class="line"><span class="comment">% inputs:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7"> 7</a></span><span class="line"><span class="comment">%               x: (27x1) double, state vector as described in text</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8"> 8</a></span><span class="line"><span class="comment">%             Pxx: (10x10) double, state covariance matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9"> 9</a></span><span class="line"><span class="comment">%               R: (17x17) double, noise covariance matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10">10</a></span><span class="line"><span class="comment">%            AHRS: (10x1) double, AHRS inputs (quaternions,accelerometers,gyroscopes)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11">11</a></span><span class="line"><span class="comment">%             GPS: (4x1) double, GPS measurement vectpr (x,y,u,v - NED)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12">12</a></span><span class="line"><span class="comment">%             BAR: (1x1) double, Barometer measurement (height in meters)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13">13</a></span><span class="line"><span class="comment">%              RF: (1x1) double, Range finder (range from fround in meters)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14">14</a></span><span class="line"><span class="comment">%            type: (1x1) uint8, measurement update case</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15">15</a></span><span class="line"><span class="comment">%              dt: (1x1) double, time elapsed (s) since last estimation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16">16</a></span><span class="line"><span class="comment">% outputs:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17">17</a></span><span class="line"><span class="comment">%               x:  Updated state vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18">18</a></span><span class="line"><span class="comment">%             Pxx:  Updated state covariance matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20">20</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21">21</a></span><span class="line"><span class="comment">% sigma points generation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22">22</a></span><span class="line"><span class="mxinfo" id="T5:U19"><span class="var type1" id="S14T5U21">X</span> = <span class="mxinfo" id="T5:U21">zeros(53,53)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23">23</a></span><span class="line"><span class="mxinfo" id="T6:U22"><span class="var type1" id="S16T6U28">xa</span> = <span class="mxinfo" id="T6:U24">zeros(26,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24">24</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,25">25</a></span><span class="line"><span class="comment">% covariance matrix augmentation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26">26</a></span><span class="line"><span class="mxinfo" id="T7:U25"><span class="var type1" id="S17T7U35">Pa</span> = <span class="mxinfo" id="T7:U27">[<span class="mxinfo" id="T60:U28"><span class="var type1" id="S3T1U38">Pxx</span> <span class="mxinfo" id="T61:U30">zeros(length(<span class="var type1" id="S3T1U43">Pxx</span>),length(<span class="var type1" id="S4T4U46">R</span>))</span></span>; <span class="mxinfo" id="T62:U33"><span class="mxinfo" id="T63:U34">zeros(length(<span class="var type1" id="S4T4U52">R</span>),length(<span class="var type1" id="S3T1U55">Pxx</span>))</span> <span class="var type1" id="S4T4U56">R</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27">27</a></span><span class="line"><span class="mxinfo" id="T6:U38"><span class="var type1" id="S16T6U59">xa</span> = <span class="mxinfo" id="T6:U40">[<span class="var type1" id="S2T2U62">x</span>;<span class="mxinfo" id="T64:U42">zeros(16,1)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28">28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,29">29</a></span><span class="line"><span class="comment">%TODO check for positive definite</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30">30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31">31</a></span><span class="line"><span class="comment">%Calculation of Sigma Points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32">32</a></span><span class="line"><span class="mxinfo" id="T46:U43"><span class="var type1" id="S14T46U70">X</span> = <span class="mxinfo" id="T46:U45"><span class="fcn" id="F39N5:B72">SigmaPoints</span>(<span class="var type1" id="S14T5U73">X</span>,<span class="var type1" id="S16T6U74">xa</span>,<span class="var type1" id="S17T7U75">Pa</span>,<span class="var type1" id="S13T3U76">c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34">34</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35">35</a></span><span class="line"><span class="comment">% state prediction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36">36</a></span><span class="line"><span class="mxinfo" id="T19:U50"><span class="var type1" id="S20T19U79">Y</span>=<span class="mxinfo" id="T19:U52">zeros(10,53)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37">37</a></span><span class="line"><span class="mxinfo" id="T2:U53"><span class="var type1" id="S21T2U86">y</span>=<span class="mxinfo" id="T2:U55">zeros(10,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38">38</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,39">39</a></span><span class="line"><span class="comment">% UT for state prediction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40">40</a></span><span class="line"><span class="mxinfo" id="T2:U56">[<span class="var type1" id="S21T2U94">y</span>,<span class="var type1" id="S20T19U95">Y</span>,<span class="var type1" id="S3T1U96">Pxx</span>,<span class="var type1" id="S22T19U97">dY</span>] = <span class="fcn" id="F152N7:B99">UnscentedTransformStates</span>(<span class="var type1" id="S21T2U100">y</span>,<span class="var type1" id="S20T19U101">Y</span>,<span class="var type1" id="S14T46U102">X</span>,<span class="var type1" id="S11T20U103">Wm</span>,<span class="var type1" id="S12T20U104">Wc</span>,<span class="var type1" id="S5T2U105">AHRS</span>,<span class="var type1" id="S10T3U106">dt</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41">41</a></span><span class="line"><span class="mxinfo" id="T2:U68"><span class="var type1" id="S2T2U109">x</span>=<span class="var type1" id="S21T2U110">y</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42">42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,43">43</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44">44</a></span><span class="line"><span class="comment">% measurement update</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45">45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,46">46</a></span><span class="line"><span class="comment">% Construct the measurement vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47">47</a></span><span class="line"><span class="mxinfo" id="T3:U71"><span class="var type1" id="S24T3U113">m</span>=<span class="mxinfo" id="T3:U73">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48">48</a></span><span class="line"><span class="mxinfo" id="T45:U74"><span class="var type1" id="S25T45U117">z_meas</span>=<span class="mxinfo" id="T45:U76">zeros(6,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49">49</a></span><span class="line"><span class="mxinfo" id="T45:U77"><span class="var type1" id="S26T45U124">z</span>=<span class="mxinfo" id="T45:U79">zeros(6,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50">50</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo" id="T13:U80">bitand(<span class="mxinfo" id="T29:U81">bitshift(<span class="var type1" id="S9T29U136">type</span>,<span class="mxinfo" id="T3:U83">0</span>)</span>,<span class="mxinfo" id="T3:U84">1</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,51">51</a></span><span class="line">    <span class="mxinfo" id="T23:U85"><span class="mxinfo" id="T23:U86"><span class="var type1" id="S25T45U142">z_meas</span>(<span class="mxinfo" id="T23:U88"><span class="mxinfo" id="T3:U89"><span class="var type1" id="S24T3U144">m</span></span>:<span class="mxinfo" id="T3:U91"><span class="var type1" id="S24T3U146">m</span>+3</span></span>,<span class="mxinfo" id="T3:U93">1</span>)</span> = <span class="var type1" id="S6T23U149">GPS</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52">52</a></span><span class="line">    <span class="mxinfo" id="T3:U95"><span class="var type1" id="S24T3U152">m</span>=<span class="mxinfo" id="T3:U97"><span class="var type1" id="S24T3U154">m</span>+<span class="mxinfo" id="T3:U99">4</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53">53</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54">54</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo" id="T13:U100">bitand(<span class="mxinfo" id="T29:U101">bitshift(<span class="var type1" id="S9T29U163">type</span>,<span class="mxinfo" id="T3:U103">-1</span>)</span>,<span class="mxinfo" id="T3:U104">1</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,55">55</a></span><span class="line">    <span class="mxinfo" id="T3:U105"><span class="mxinfo" id="T3:U106"><span class="var type1" id="S25T45U170">z_meas</span>(<span class="mxinfo" id="T15:U108"><span class="var type1" id="S24T3U172">m</span>+<span class="mxinfo" id="T3:U110">1</span></span>,<span class="mxinfo" id="T3:U111">1</span>)</span> = <span class="var type1" id="S7T3U175">BAR</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56">56</a></span><span class="line">    <span class="mxinfo" id="T3:U113"><span class="var type1" id="S24T3U178">m</span>=<span class="mxinfo" id="T3:U115"><span class="var type1" id="S24T3U180">m</span>+<span class="mxinfo" id="T3:U117">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57">57</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58">58</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo" id="T13:U118">bitand(<span class="mxinfo" id="T29:U119">bitshift(<span class="var type1" id="S9T29U189">type</span>,<span class="mxinfo" id="T3:U121">-2</span>)</span>,<span class="mxinfo" id="T3:U122">1</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,59">59</a></span><span class="line">    <span class="mxinfo" id="T3:U123"><span class="mxinfo" id="T3:U124"><span class="var type1" id="S25T45U196">z_meas</span>(<span class="mxinfo" id="T15:U126"><span class="var type1" id="S24T3U198">m</span>+<span class="mxinfo" id="T3:U128">1</span></span>,<span class="mxinfo" id="T3:U129">1</span>)</span> = <span class="var type1" id="S8T3U201">RF</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60">60</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61">61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62">62</a></span><span class="line"><span class="keyword">if</span> (<span class="mxinfo" id="T13:U131"><span class="var type1" id="S24T3U206">m</span>==<span class="mxinfo" id="T3:U133">0</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,63">63</a></span><span class="line">    <span class="keyword">return</span>; <span class="comment">%No measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64">64</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65">65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66">66</a></span><span class="line"><span class="comment">% UT for measurement prediction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67">67</a></span><span class="line"><span class="mxinfo" id="T21:U134">[<span class="var type1" id="S29T47U212">zz</span>,<span class="var type1" id="S30T48U213">Pzz</span>,<span class="var type1" id="S31T49U214">dZ</span>] = <span class="fcn" id="F238N6:B216">UnscentedTransformMeasurements</span>(<span class="mxinfo" id="T52:U138">[<span class="var type1" id="S20T19U219">Y</span> ; <span class="mxinfo" id="T65:U140"><span class="var type1" id="S14T46U222">X</span>(<span class="mxinfo" id="T66:U142"><span class="mxinfo" id="T3:U143">11</span>:<span class="mxinfo" id="T3:U144">end</span></span>,<span class="mxinfo" id="T67:U145">:</span>)</span>]</span>,<span class="var type1" id="S11T20U228">Wm</span>,<span class="var type1" id="S12T20U229">Wc</span>,<span class="var type1" id="S5T2U230">AHRS</span>,<span class="var type1" id="S9T29U231">type</span>,<span class="var type1" id="S24T3U232">m</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68">68</a></span><span class="line"><span class="mxinfo" id="T47:U151"><span class="mxinfo" id="T47:U152"><span class="var type1" id="S26T45U236">z</span>(<span class="mxinfo" id="T68:U154"><span class="mxinfo" id="T3:U155">1</span>:<span class="var type1" id="S24T3U239">m</span></span>,<span class="mxinfo" id="T15:U157">1</span>)</span>=<span class="var type1" id="S29T47U241">zz</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69">69</a></span><span class="line"><span class="comment">% cross covariance matrix assembly</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70">70</a></span><span class="line"><span class="mxinfo" id="T50:U159"><span class="var type1" id="S34T50U244">Pxz</span> = <span class="mxinfo" id="T50:U161">zeros(length(<span class="var type1" id="S3T1U249">Pxx</span>),<span class="var type1" id="S24T3U250">m</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,71">71</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S35T3U253">j</span> = <span class="mxinfo" id="T3:U165">1</span>:<span class="mxinfo" id="T3:U166">1</span>:<span class="mxinfo" id="T3:U167">size(<span class="var type1" id="S20T19U260">Y</span>,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72">72</a></span><span class="line">    <span class="mxinfo" id="T50:U169"><span class="var type1" id="S34T50U264">Pxz</span> = <span class="var type1" id="S34T50U266">Pxz</span> + <span class="mxinfo" id="T50:U172"><span class="mxinfo" id="T2:U173"><span class="mxinfo" id="T3:U174"><span class="var type1" id="S12T20U270">Wc</span>(<span class="var type1" id="S35T3U271">j</span>)</span> * <span class="mxinfo" id="T2:U177"><span class="var type1" id="S22T19U273">dY</span>(<span class="mxinfo" id="T69:U179">:</span>,<span class="var type1" id="S35T3U275">j</span>)</span></span> * <span class="mxinfo" id="T57:U181"><span class="mxinfo" id="T47:U182"><span class="var type1" id="S31T49U278">dZ</span>(<span class="mxinfo" id="T68:U184">:</span>,<span class="var type1" id="S35T3U280">j</span>)</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73">73</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74">74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,75">75</a></span><span class="line"><span class="comment">% Kalman gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76">76</a></span><span class="line"><span class="mxinfo" id="T44:U186"><span class="var type1" id="S37T44U283">K</span>=<span class="mxinfo" id="T44:U188">zeros(10,6)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77">77</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,78">78</a></span><span class="line"><span class="mxinfo" id="T50:U189"><span class="mxinfo" id="T50:U190"><span class="var type1" id="S37T44U291">K</span>(<span class="mxinfo" id="T69:U192">:</span>,<span class="mxinfo" id="T68:U193"><span class="mxinfo" id="T3:U194">1</span>:<span class="var type1" id="S24T3U295">m</span></span>)</span> = <span class="mxinfo" id="T50:U196"><span class="var type1" id="S34T50U297">Pxz</span>/<span class="var type1" id="S30T48U298">Pzz</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79">79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,80">80</a></span><span class="line"><span class="comment">% state update</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81">81</a></span><span class="line"><span class="mxinfo" id="T2:U199"><span class="var type1" id="S2T2U301">x</span> = <span class="mxinfo" id="T2:U201"><span class="var type1" id="S2T2U303">x</span> + <span class="mxinfo" id="T2:U203"><span class="var type1" id="S37T44U305">K</span>*(<span class="mxinfo" id="T45:U205"><span class="var type1" id="S25T45U308">z_meas</span>-<span class="var type1" id="S26T45U309">z</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82">82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,83">83</a></span><span class="line"><span class="comment">% covariance update</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84">84</a></span><span class="line"><span class="mxinfo" id="T1:U208"><span class="var type1" id="S3T1U312">Pxx</span> = <span class="mxinfo" id="T1:U210"><span class="var type1" id="S3T1U314">Pxx</span> - <span class="mxinfo" id="T1:U212"><span class="mxinfo" id="T50:U213"><span class="mxinfo" id="T50:U214"><span class="var type1" id="S37T44U318">K</span>(<span class="mxinfo" id="T69:U216">:</span>,<span class="mxinfo" id="T68:U217"><span class="mxinfo" id="T3:U218">1</span>:<span class="var type1" id="S24T3U322">m</span></span>)</span> * <span class="var type1" id="S30T48U323">Pzz</span></span> * <span class="mxinfo" id="T58:U221"><span class="mxinfo" id="T50:U222"><span class="var type1" id="S37T44U326">K</span>(<span class="mxinfo" id="T69:U224">:</span>,<span class="mxinfo" id="T68:U225"><span class="mxinfo" id="T3:U226">1</span>:<span class="var type1" id="S24T3U330">m</span></span>)</span>'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85">85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,86">86</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
