<pre class="code">
<span class="srcline"><span class="lineno"><a href="71,1"> 1</a></span><span class="line"><span class="comment">%% Helicopter Measurement model</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,3"> 3</a></span><span class="line"><span class="comment">% measurment vector - size is not static</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,4"> 4</a></span><span class="line"><span class="comment">%    x(1) : Barometer altitude (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,5"> 5</a></span><span class="line"><span class="comment">%    x(2) : Range finder - range (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,6"> 6</a></span><span class="line"><span class="comment">%    x(3) : GPS position x (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,7"> 7</a></span><span class="line"><span class="comment">%    x(4) : GPS position y (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,8"> 8</a></span><span class="line"><span class="comment">%    x(5) : GPS velocity N (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,9"> 9</a></span><span class="line"><span class="comment">%    x(6) : GPS velocity E (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,10">10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,11">11</a></span><span class="line"><span class="comment">% state vector (augmented):</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,12">12</a></span><span class="line"><span class="comment">%    x(1) : position / N (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,13">13</a></span><span class="line"><span class="comment">%    x(2) : position / E (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,14">14</a></span><span class="line"><span class="comment">%    x(3) : height (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,15">15</a></span><span class="line"><span class="comment">%    x(4) : velocity N (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,16">16</a></span><span class="line"><span class="comment">%    x(5) : velocity E (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,17">17</a></span><span class="line"><span class="comment">%    x(6) : velocity D (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,18">18</a></span><span class="line"><span class="comment">%    x(7) : accelerometer bias x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,19">19</a></span><span class="line"><span class="comment">%    x(8) : accelerometer bias y (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,20">20</a></span><span class="line"><span class="comment">%    x(9) : accelerometer bias z (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,21">21</a></span><span class="line"><span class="comment">%    x(10): barometer bias (mbar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,22">22</a></span><span class="line"><span class="comment">%    ---------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,23">23</a></span><span class="line"><span class="comment">%    x(11): gps postion x noise (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,24">24</a></span><span class="line"><span class="comment">%    x(12): gps postion y noise (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,25">25</a></span><span class="line"><span class="comment">%    x(13): gps velocity N noise (m/s) </span></span></span>
<span class="srcline"><span class="lineno"><a href="71,26">26</a></span><span class="line"><span class="comment">%    x(14): gps velocity E noise (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,27">27</a></span><span class="line"><span class="comment">%    x(15): accelerometer x noise (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,28">28</a></span><span class="line"><span class="comment">%    x(16): accelerometer y noise (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,29">29</a></span><span class="line"><span class="comment">%    x(17): accelerometer z noise (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,30">30</a></span><span class="line"><span class="comment">%    x(18): barometer noise (mbar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,31">31</a></span><span class="line"><span class="comment">%    x(19): altimeter noise (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,32">32</a></span><span class="line"><span class="comment">%    x(20): AHRS noise angle x (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,33">33</a></span><span class="line"><span class="comment">%    x(21): AHRS noise angle y (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,34">34</a></span><span class="line"><span class="comment">%    x(22): AHRS noise angle z (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,35">35</a></span><span class="line"><span class="comment">%    x(23): accelerometer bias parameter x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,36">36</a></span><span class="line"><span class="comment">%    x(24): accelerometer bias parameter y (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,37">37</a></span><span class="line"><span class="comment">%    x(25): accelerometer bias parameter z (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,38">38</a></span><span class="line"><span class="comment">%    x(26): barometer bias parameter (mbar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,39">39</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,40">40</a></span><span class="line"><span class="comment">% inputs (AHRS - internal estimation filter):</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,41">41</a></span><span class="line"><span class="comment">%    u(1) : q1 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,42">42</a></span><span class="line"><span class="comment">%    u(2) : q2 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,43">43</a></span><span class="line"><span class="comment">%    u(3) : q3 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,44">44</a></span><span class="line"><span class="comment">%    u(4) : q4 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,45">45</a></span><span class="line"><span class="comment">%    u(5) : wx - gyro x (rad/sec)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,46">46</a></span><span class="line"><span class="comment">%    u(6) : wy - gyro x (rad/sec)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,47">47</a></span><span class="line"><span class="comment">%    u(7) : wz - gyro x (rad/sec)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,48">48</a></span><span class="line"><span class="comment">%    u(8) : ax - accelerometer body x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,49">49</a></span><span class="line"><span class="comment">%    u(9) : ay - accelerometer body x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,50">50</a></span><span class="line"><span class="comment">%    u(10): az - accelerometer body x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,51">51</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,52">52</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T47U3">z</span>] = Measurement_model( <span class="var type1" id="S3T53U6">x</span> , <span class="var type1" id="S4T2U7">u</span>, <span class="var type1" id="S5T29U8">type</span>,<span class="var type1" id="S6T3U9">m</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="71,53">53</a></span><span class="line">coder.inline(<span class="string">'never'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="71,54">54</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,55">55</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,56">56</a></span><span class="line"><span class="mxinfo" id="T47:U6"><span class="var type1" id="S2T47U18">z</span>=<span class="mxinfo" id="T47:U8">zeros(<span class="var type1" id="S6T3U21">m</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,57">57</a></span><span class="line"><span class="mxinfo" id="T3:U10"><span class="var type1" id="S9T3U25">i</span>=<span class="mxinfo" id="T3:U12">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,58">58</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,59">59</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo" id="T13:U13">bitand(<span class="mxinfo" id="T29:U14">bitshift(<span class="var type1" id="S5T29U34">type</span>,<span class="mxinfo" id="T3:U16">0</span>)</span>,<span class="mxinfo" id="T3:U17">1</span>)</span>) <span class="comment">%GPS availiable</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,60">60</a></span><span class="line">    <span class="mxinfo" id="T102:U18"><span class="mxinfo" id="T102:U19"><span class="var type1" id="S2T47U40">z</span>(<span class="mxinfo" id="T102:U21"><span class="mxinfo" id="T3:U22"><span class="var type1" id="S9T3U42">i</span></span>:<span class="mxinfo" id="T3:U24"><span class="var type1" id="S9T3U44">i</span>+1</span></span>,<span class="mxinfo" id="T3:U26">1</span>)</span>=<span class="mxinfo" id="T102:U27"><span class="mxinfo" id="T102:U28"><span class="var type1" id="S3T53U49">x</span>(<span class="mxinfo" id="T102:U30"><span class="mxinfo" id="T3:U31">1</span>:<span class="mxinfo" id="T3:U32">2</span></span>,<span class="mxinfo" id="T3:U33">1</span>)</span>+<span class="mxinfo" id="T102:U34"><span class="var type1" id="S3T53U55">x</span>(<span class="mxinfo" id="T102:U36"><span class="mxinfo" id="T3:U37">11</span>:<span class="mxinfo" id="T3:U38">12</span></span>,<span class="mxinfo" id="T3:U39">1</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,61">61</a></span><span class="line">    <span class="mxinfo" id="T3:U40"><span class="mxinfo" id="T3:U41"><span class="var type1" id="S2T47U63">z</span>(<span class="mxinfo" id="T15:U43"><span class="var type1" id="S9T3U65">i</span>+2</span>,<span class="mxinfo" id="T3:U45">1</span>)</span>=<span class="mxinfo" id="T3:U46"><span class="mxinfo" id="T3:U47"><span class="var type1" id="S3T53U70">x</span>(<span class="mxinfo" id="T3:U49">4</span>)</span>+<span class="mxinfo" id="T3:U50"><span class="var type1" id="S3T53U73">x</span>(<span class="mxinfo" id="T3:U52">13</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,62">62</a></span><span class="line">    <span class="mxinfo" id="T3:U53"><span class="mxinfo" id="T3:U54"><span class="var type1" id="S2T47U78">z</span>(<span class="mxinfo" id="T15:U56"><span class="var type1" id="S9T3U80">i</span>+3</span>,<span class="mxinfo" id="T3:U58">1</span>)</span>=<span class="mxinfo" id="T3:U59"><span class="mxinfo" id="T3:U60"><span class="var type1" id="S3T53U85">x</span>(<span class="mxinfo" id="T3:U62">5</span>)</span>+<span class="mxinfo" id="T3:U63"><span class="var type1" id="S3T53U88">x</span>(<span class="mxinfo" id="T3:U65">14</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,63">63</a></span><span class="line">    <span class="mxinfo" id="T3:U66"><span class="var type1" id="S9T3U92">i</span>=<span class="mxinfo" id="T3:U68"><span class="var type1" id="S9T3U94">i</span>+<span class="mxinfo" id="T3:U70">4</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,64">64</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,65">65</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo" id="T13:U71">bitand(<span class="mxinfo" id="T29:U72">bitshift(<span class="var type1" id="S5T29U103">type</span>,<span class="mxinfo" id="T3:U74">-1</span>)</span>,<span class="mxinfo" id="T3:U75">1</span>)</span>) <span class="comment">%Barometer availiable</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,66">66</a></span><span class="line">    <span class="mxinfo" id="T3:U76"><span class="mxinfo" id="T3:U77"><span class="var type1" id="S2T47U110">z</span>(<span class="var type1" id="S9T3U111">i</span>,<span class="mxinfo" id="T3:U80">1</span>)</span>=<span class="mxinfo" id="T3:U81"><span class="mxinfo" id="T3:U82"><span class="mxinfo" id="T3:U83"><span class="var type1" id="S3T53U116">x</span>(<span class="mxinfo" id="T3:U85">3</span>)</span>-<span class="mxinfo" id="T3:U86"><span class="var type1" id="S3T53U119">x</span>(<span class="mxinfo" id="T3:U88">10</span>)</span></span>-<span class="mxinfo" id="T3:U89"><span class="var type1" id="S3T53U122">x</span>(<span class="mxinfo" id="T3:U91">26</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,67">67</a></span><span class="line">    <span class="mxinfo" id="T3:U92"><span class="var type1" id="S9T3U126">i</span>=<span class="mxinfo" id="T3:U94"><span class="var type1" id="S9T3U128">i</span>+<span class="mxinfo" id="T3:U96">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,68">68</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,69">69</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo" id="T13:U97">bitand(<span class="mxinfo" id="T29:U98">bitshift(<span class="var type1" id="S5T29U137">type</span>,<span class="mxinfo" id="T3:U100">-2</span>)</span>,<span class="mxinfo" id="T3:U101">2</span>)</span>)  <span class="comment">%Altimeter range</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,70">70</a></span><span class="line">    <span class="mxinfo" id="T54:U102"><span class="var type1" id="S12T54U143">quat_noise</span>= <span class="mxinfo" id="T54:U104"><span class="fcn" id="F203N9:B145">quat_rotation_custom</span>(<span class="mxinfo" id="T55:U105"><span class="mxinfo" id="T3:U106"><span class="var type1" id="S3T53U148">x</span>(<span class="mxinfo" id="T3:U108">20</span>)</span>:<span class="mxinfo" id="T3:U109"><span class="var type1" id="S3T53U151">x</span>(<span class="mxinfo" id="T3:U111">22</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,71">71</a></span><span class="line">    <span class="mxinfo" id="T23:U112"><span class="var type1" id="S14T23U155">quat</span> = <span class="mxinfo" id="T23:U114"><span class="fcn" id="F92N11:B157">quatnorm_custom</span>(<span class="mxinfo" id="T23:U115"><span class="fcn" id="F204N10:B159">quatmult_custom</span>(<span class="mxinfo" id="T23:U116"><span class="var type1" id="S4T2U161">u</span>(<span class="mxinfo" id="T23:U118"><span class="mxinfo" id="T3:U119">1</span>:<span class="mxinfo" id="T3:U120">4</span></span>,<span class="mxinfo" id="T3:U121">1</span>)</span>, <span class="var type1" id="S12T54U166">quat_noise</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,72">72</a></span><span class="line">    <span class="mxinfo" id="T3:U123"><span class="var type1" id="S17T3U169">r33</span>=<span class="mxinfo" id="T3:U125"><span class="mxinfo" id="T3:U126"><span class="mxinfo" id="T3:U127"><span class="mxinfo" id="T3:U128"><span class="mxinfo" id="T3:U129"><span class="var type1" id="S14T23U175">quat</span>(<span class="mxinfo" id="T3:U131">1</span>)</span>^2</span> - <span class="mxinfo" id="T3:U132"><span class="mxinfo" id="T3:U133"><span class="var type1" id="S14T23U180">quat</span>(<span class="mxinfo" id="T3:U135">2</span>)</span>^2</span></span> - <span class="mxinfo" id="T3:U136"><span class="mxinfo" id="T3:U137"><span class="var type1" id="S14T23U185">quat</span>(<span class="mxinfo" id="T3:U139">3</span>)</span>^2</span></span> + <span class="mxinfo" id="T3:U140"><span class="mxinfo" id="T3:U141"><span class="var type1" id="S14T23U190">quat</span>(<span class="mxinfo" id="T3:U143">4</span>)</span>^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,73">73</a></span><span class="line">    <span class="mxinfo" id="T3:U144"><span class="mxinfo" id="T3:U145"><span class="var type1" id="S2T47U196">z</span>(<span class="var type1" id="S9T3U197">i</span>,<span class="mxinfo" id="T3:U148">1</span>)</span>=(<span class="mxinfo" id="T3:U149"><span class="mxinfo" id="T3:U150"><span class="mxinfo" id="T3:U151"><span class="var type1" id="S3T53U203">x</span>(<span class="mxinfo" id="T3:U153">3</span>)</span>/<span class="var type1" id="S17T3U205">r33</span></span>+<span class="mxinfo" id="T3:U155"><span class="var type1" id="S3T53U207">x</span>(<span class="mxinfo" id="T3:U157">19</span>)</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,74">74</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
</pre>
