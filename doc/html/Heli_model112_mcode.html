<pre class="code">
<span class="srcline"><span class="lineno"><a href="52,1"> 1</a></span><span class="line"><span class="comment">%% Helicopter Model</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,3"> 3</a></span><span class="line"><span class="comment">% state vector (augmented):</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,4"> 4</a></span><span class="line"><span class="comment">%    x(1) : position / N (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,5"> 5</a></span><span class="line"><span class="comment">%    x(2) : position / E (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,6"> 6</a></span><span class="line"><span class="comment">%    x(3) : height (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,7"> 7</a></span><span class="line"><span class="comment">%    x(4) : velocity N (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,8"> 8</a></span><span class="line"><span class="comment">%    x(5) : velocity E (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,9"> 9</a></span><span class="line"><span class="comment">%    x(6) : velocity D (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,10">10</a></span><span class="line"><span class="comment">%    x(7) : accelerometer bias x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,11">11</a></span><span class="line"><span class="comment">%    x(8) : accelerometer bias y (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,12">12</a></span><span class="line"><span class="comment">%    x(9) : accelerometer bias z (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,13">13</a></span><span class="line"><span class="comment">%    x(10): barometer bias (mbar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,14">14</a></span><span class="line"><span class="comment">%    ---------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,15">15</a></span><span class="line"><span class="comment">%    x(11): gps postion x noise (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,16">16</a></span><span class="line"><span class="comment">%    x(12): gps postion y noise (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,17">17</a></span><span class="line"><span class="comment">%    x(13): gps velocity N noise (m/s) </span></span></span>
<span class="srcline"><span class="lineno"><a href="52,18">18</a></span><span class="line"><span class="comment">%    x(14): gps velocity E noise (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,19">19</a></span><span class="line"><span class="comment">%    x(15): accelerometer x noise (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,20">20</a></span><span class="line"><span class="comment">%    x(16): accelerometer y noise (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,21">21</a></span><span class="line"><span class="comment">%    x(17): accelerometer z noise (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,22">22</a></span><span class="line"><span class="comment">%    x(18): barometer noise (mbar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,23">23</a></span><span class="line"><span class="comment">%    x(19): altimeter noise (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,24">24</a></span><span class="line"><span class="comment">%    x(20): AHRS noise angle x (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,25">25</a></span><span class="line"><span class="comment">%    x(21): AHRS noise angle y (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,26">26</a></span><span class="line"><span class="comment">%    x(22): AHRS noise angle z (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,27">27</a></span><span class="line"><span class="comment">%    x(23): accelerometer bias parameter x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,28">28</a></span><span class="line"><span class="comment">%    x(24): accelerometer bias parameter y (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,29">29</a></span><span class="line"><span class="comment">%    x(25): accelerometer bias parameter z (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,30">30</a></span><span class="line"><span class="comment">%    x(26): barometer bias parameter (mbar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,31">31</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,32">32</a></span><span class="line"><span class="comment">% inputs (AHRS - internal estimation filter):</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,33">33</a></span><span class="line"><span class="comment">%    u(1) : q1 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,34">34</a></span><span class="line"><span class="comment">%    u(2) : q2 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,35">35</a></span><span class="line"><span class="comment">%    u(3) : q3 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,36">36</a></span><span class="line"><span class="comment">%    u(4) : q4 - quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,37">37</a></span><span class="line"><span class="comment">%    u(5) : wx - gyro x (rad/sec)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,38">38</a></span><span class="line"><span class="comment">%    u(6) : wy - gyro y (rad/sec)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,39">39</a></span><span class="line"><span class="comment">%    u(7) : wz - gyro z (rad/sec)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,40">40</a></span><span class="line"><span class="comment">%    u(8) : ax - accelerometer body x (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,41">41</a></span><span class="line"><span class="comment">%    u(9) : ay - accelerometer body y (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,42">42</a></span><span class="line"><span class="comment">%    u(10): az - accelerometer body z (g)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,43">43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,44">44</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,45">45</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T2U3">y</span>] = Heli_model(<span class="var type1" id="S3T51U6">x</span>,<span class="var type1" id="S4T2U7">u</span>,<span class="var type1" id="S5T3U8">dt</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="52,46">46</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,47">47</a></span><span class="line">coder.inline(<span class="string">'never'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="52,48">48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,49">49</a></span><span class="line"><span class="mxinfo" id="T3:U5"><span class="var type1" id="S7T3U17">grav</span>=<span class="mxinfo" id="T3:U7">9.8</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,50">50</a></span><span class="line"><span class="mxinfo" id="T2:U8"><span class="var type1" id="S2T2U21">y</span>=<span class="mxinfo" id="T2:U10">zeros(10,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,51">51</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,52">52</a></span><span class="line"><span class="comment">% removing noise from quaternions measurements (noise is in rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,53">53</a></span><span class="line"><span class="mxinfo" id="T23:U11"><span class="var type1" id="S9T23U28">quat_noise</span>= <span class="mxinfo" id="T23:U13"><span class="fcn" id="F60N9:B30">quat_rotation_custom</span>(<span class="mxinfo" id="T22:U14">-<span class="mxinfo" id="T22:U15"><span class="var type1" id="S3T51U33">x</span>(<span class="mxinfo" id="T22:U17"><span class="mxinfo" id="T3:U18">20</span>:<span class="mxinfo" id="T3:U19">22</span></span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,54">54</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,55">55</a></span><span class="line"><span class="mxinfo" id="T23:U20"><span class="var type1" id="S11T23U39">quat</span> = <span class="mxinfo" id="T23:U22"><span class="fcn" id="F92N11:B41">quatnorm_custom</span>(<span class="mxinfo" id="T23:U23"><span class="fcn" id="F75N10:B43">quatmult_custom</span>(<span class="mxinfo" id="T23:U24"><span class="var type1" id="S4T2U45">u</span>(<span class="mxinfo" id="T23:U26"><span class="mxinfo" id="T3:U27">1</span>:<span class="mxinfo" id="T3:U28">4</span></span>,<span class="mxinfo" id="T3:U29">1</span>)</span>, <span class="var type1" id="S9T23U50">quat_noise</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,56">56</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,57">57</a></span><span class="line"><span class="comment">% remove bias and noise from acc measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,58">58</a></span><span class="line"><span class="mxinfo" id="T22:U31"><span class="var type1" id="S14T22U53">acc</span> = <span class="mxinfo" id="T22:U33"><span class="mxinfo" id="T22:U34"><span class="var type1" id="S4T2U56">u</span>(<span class="mxinfo" id="T22:U36"><span class="mxinfo" id="T3:U37">8</span>:<span class="mxinfo" id="T3:U38">10</span></span>,<span class="mxinfo" id="T3:U39">1</span>)</span> - <span class="mxinfo" id="T22:U40"><span class="var type1" id="S3T51U62">x</span>(<span class="mxinfo" id="T22:U42"><span class="mxinfo" id="T3:U43">7</span>:<span class="mxinfo" id="T3:U44">9</span></span>,<span class="mxinfo" id="T3:U45">1</span>)</span></span></span>; - <span class="var type1" id="S3T51U70">x</span>(<span class="mxinfo" id="T22:U47"><span class="mxinfo" id="T3:U48">15</span>:<span class="mxinfo" id="T3:U49">17</span></span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="52,59">59</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,60">60</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,61">61</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,62">62</a></span><span class="line"><span class="comment">% position propagation</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,63">63</a></span><span class="line"><span class="mxinfo" id="T22:U50"><span class="var type1" id="S15T22U77">acc_e</span> = <span class="mxinfo" id="T22:U52"><span class="var type1" id="S7T3U79">grav</span>*(<span class="mxinfo" id="T22:U54"><span class="mxinfo" id="T22:U55"><span class="mxinfo" id="T27:U56"><span class="fcn" id="F95N4:B84">Rbn</span>(<span class="var type1" id="S11T23U85">quat</span>)</span>*<span class="var type1" id="S14T22U86">acc</span></span>+<span class="mxinfo" id="T22:U59"><span class="mxinfo" id="T84:U60">[<span class="mxinfo" id="T3:U61">0</span> <span class="mxinfo" id="T3:U62">0</span> <span class="mxinfo" id="T3:U63">1</span>]</span>'</span></span>)</span></span>; <span class="comment">%Compute acceleration on inertial frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,64">64</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,65">65</a></span><span class="line"><span class="mxinfo" id="T3:U64"><span class="mxinfo" id="T3:U65"><span class="var type1" id="S2T2U96">y</span>(<span class="mxinfo" id="T3:U67">1</span>,<span class="mxinfo" id="T3:U68">1</span>)</span> = <span class="mxinfo" id="T3:U69"><span class="mxinfo" id="T3:U70"><span class="mxinfo" id="T3:U71"><span class="var type1" id="S3T51U102">x</span>(<span class="mxinfo" id="T3:U73">1</span>,<span class="mxinfo" id="T3:U74">1</span>)</span> + <span class="mxinfo" id="T3:U75"><span class="mxinfo" id="T3:U76"><span class="var type1" id="S3T51U107">x</span>(<span class="mxinfo" id="T3:U78">4</span>,<span class="mxinfo" id="T3:U79">1</span>)</span>*<span class="var type1" id="S5T3U110">dt</span></span></span> + <span class="mxinfo" id="T3:U81"><span class="mxinfo" id="T3:U82"><span class="mxinfo" id="T3:U83">0.5</span>*<span class="mxinfo" id="T3:U84"><span class="var type1" id="S15T22U115">acc_e</span>(<span class="mxinfo" id="T3:U86">1</span>)</span></span>*<span class="mxinfo" id="T3:U87"><span class="var type1" id="S5T3U118">dt</span>^2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,66">66</a></span><span class="line"><span class="mxinfo" id="T3:U89"><span class="mxinfo" id="T3:U90"><span class="var type1" id="S2T2U123">y</span>(<span class="mxinfo" id="T3:U92">2</span>,<span class="mxinfo" id="T3:U93">1</span>)</span> = <span class="mxinfo" id="T3:U94"><span class="mxinfo" id="T3:U95"><span class="mxinfo" id="T3:U96"><span class="var type1" id="S3T51U129">x</span>(<span class="mxinfo" id="T3:U98">2</span>,<span class="mxinfo" id="T3:U99">1</span>)</span> + <span class="mxinfo" id="T3:U100"><span class="mxinfo" id="T3:U101"><span class="var type1" id="S3T51U134">x</span>(<span class="mxinfo" id="T3:U103">5</span>,<span class="mxinfo" id="T3:U104">1</span>)</span>*<span class="var type1" id="S5T3U137">dt</span></span></span> + <span class="mxinfo" id="T3:U106"><span class="mxinfo" id="T3:U107"><span class="mxinfo" id="T3:U108">0.5</span>*<span class="mxinfo" id="T3:U109"><span class="var type1" id="S15T22U142">acc_e</span>(<span class="mxinfo" id="T3:U111">2</span>)</span></span>*<span class="mxinfo" id="T3:U112"><span class="var type1" id="S5T3U145">dt</span>^2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,67">67</a></span><span class="line"><span class="mxinfo" id="T3:U114"><span class="mxinfo" id="T3:U115"><span class="var type1" id="S2T2U150">y</span>(<span class="mxinfo" id="T3:U117">3</span>,<span class="mxinfo" id="T3:U118">1</span>)</span> = <span class="mxinfo" id="T3:U119"><span class="mxinfo" id="T3:U120"><span class="mxinfo" id="T3:U121"><span class="var type1" id="S3T51U156">x</span>(<span class="mxinfo" id="T3:U123">3</span>,<span class="mxinfo" id="T3:U124">1</span>)</span> - <span class="mxinfo" id="T3:U125"><span class="mxinfo" id="T3:U126"><span class="var type1" id="S3T51U161">x</span>(<span class="mxinfo" id="T3:U128">6</span>,<span class="mxinfo" id="T3:U129">1</span>)</span>*<span class="var type1" id="S5T3U164">dt</span></span></span> - <span class="mxinfo" id="T3:U131"><span class="mxinfo" id="T3:U132"><span class="mxinfo" id="T3:U133">0.5</span>*<span class="mxinfo" id="T3:U134"><span class="var type1" id="S15T22U169">acc_e</span>(<span class="mxinfo" id="T3:U136">3</span>)</span></span>*<span class="mxinfo" id="T3:U137"><span class="var type1" id="S5T3U172">dt</span>^2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,68">68</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,69">69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,70">70</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,71">71</a></span><span class="line"><span class="comment">% velocity propagation</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,72">72</a></span><span class="line"><span class="mxinfo" id="T22:U139"><span class="mxinfo" id="T22:U140"><span class="var type1" id="S2T2U177">y</span>(<span class="mxinfo" id="T22:U142"><span class="mxinfo" id="T3:U143">4</span>:<span class="mxinfo" id="T3:U144">6</span></span>,<span class="mxinfo" id="T3:U145">1</span>)</span> = <span class="mxinfo" id="T22:U146"><span class="mxinfo" id="T22:U147"><span class="var type1" id="S3T51U184">x</span>(<span class="mxinfo" id="T22:U149"><span class="mxinfo" id="T3:U150">4</span>:<span class="mxinfo" id="T3:U151">6</span></span>,<span class="mxinfo" id="T3:U152">1</span>)</span> + <span class="mxinfo" id="T22:U153"><span class="var type1" id="S15T22U190">acc_e</span>*<span class="var type1" id="S5T3U191">dt</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,73">73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,74">74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,75">75</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,76">76</a></span><span class="line"><span class="comment">% bias propagation</span></span></span>
<span class="srcline"><span class="lineno"><a href="52,77">77</a></span><span class="line"><span class="mxinfo" id="T22:U156"><span class="mxinfo" id="T22:U157"><span class="var type1" id="S2T2U195">y</span>(<span class="mxinfo" id="T22:U159"><span class="mxinfo" id="T3:U160">7</span>:<span class="mxinfo" id="T3:U161">9</span></span>,<span class="mxinfo" id="T3:U162">1</span>)</span> = <span class="mxinfo" id="T22:U163"><span class="mxinfo" id="T22:U164"><span class="var type1" id="S3T51U202">x</span>(<span class="mxinfo" id="T22:U166"><span class="mxinfo" id="T3:U167">7</span>:<span class="mxinfo" id="T3:U168">9</span></span>,<span class="mxinfo" id="T3:U169">1</span>)</span> + <span class="mxinfo" id="T22:U170"><span class="mxinfo" id="T22:U171"><span class="var type1" id="S3T51U209">x</span>(<span class="mxinfo" id="T22:U173"><span class="mxinfo" id="T3:U174">23</span>:<span class="mxinfo" id="T3:U175">25</span></span>,<span class="mxinfo" id="T3:U176">1</span>)</span>*<span class="var type1" id="S5T3U214">dt</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,78">78</a></span><span class="line"><span class="mxinfo" id="T3:U178"><span class="mxinfo" id="T3:U179"><span class="var type1" id="S2T2U218">y</span>(<span class="mxinfo" id="T3:U181">10</span>,<span class="mxinfo" id="T3:U182">1</span>)</span>= <span class="mxinfo" id="T3:U183"><span class="mxinfo" id="T3:U184"><span class="var type1" id="S3T51U223">x</span>(<span class="mxinfo" id="T3:U186">10</span>,<span class="mxinfo" id="T3:U187">1</span>)</span> + <span class="mxinfo" id="T3:U188"><span class="mxinfo" id="T3:U189"><span class="var type1" id="S3T51U228">x</span>(<span class="mxinfo" id="T3:U191">26</span>,<span class="mxinfo" id="T3:U192">1</span>)</span>*<span class="var type1" id="S5T3U231">dt</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="52,79">79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="52,80">80</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
